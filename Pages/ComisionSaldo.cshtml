@page
@model ComisionSaldoModel
@{
    ViewData["Title"] = "Comisión por flujo";
}


<section>
    <h2>Comisión por Flujo</h2>
    <div class="row">
        <div class="col-md-6">
            <form id="my-form" method="post" class="probootstrap-form probootstrap-form-box" style="padding: 40px;">
          <div class="form-group">
            <label for="edad">Edad</label>
            <input type="number" min="1" max="100" name="edad" id="edad" class="form-control">
          </div>
             
        <label>Rentabilidad</label>
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                <label for="">60 años</label>
                <select class="form-control" id="menorSesenta">
                    <optgroup label="Fondo 0">
                    <option>2%</option>
                    <optgroup label="Fondo 1">
                    <option>3%</option>
                    <option>4%</option>
                    <optgroup label="Fondo 2">
                    <option>5%</option>
                    <option>6%</option>
                    <optgroup label="Fondo 3">
                    <option>7%</option>
                    <option>9%</option>
                </select>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                <label for="">61 a 65 años</label>
                <select class="form-control" id="mayorSesenta">
                    <optgroup label="Fondo 0">
                    <option>2%</option>
                    <optgroup label="Fondo 1">
                    <option>3%</option>
                    <option>4%</option>
                    <optgroup label="Fondo 2">
                    <option>5%</option>
                    <option>6%</option>
                </select>
                </div>
            </div>
        </div>

          <div class="form-group">
            <label for="sueldo">Sueldo</label>
            <input type="number" min="1" name="sueldo" id="sueldo" class="form-control">
          </div>

          <div class="form-group">
          <label for="">Género</label>
          <select class="form-control" id="">
            <option>Masculino</option>
            <option>Femenino</option>
          </select>
          </div>

          <div class="form-group">
          <label for="">Grado</label>
          <select class="form-control" id="">
            <option>Universidad</option>
            <option>Sin Universidad</option>
          </select>
          </div>

           <div class="row">
               <div class="col-md-offset-3 col-md-9">
                <div class="form-group">
                    <label for="">Tipo Universidad</label>
                    <select class="form-control" id="">
                        <option>Privada</option>
                        <option>Publica</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="">Nivel</label>
                    <select class="form-control" id="">
                        <option>Bachiller</option>
                        <option>Maestria</option>
                        <option>Doctorado</option>
                    </select>
                </div>
               </div>
           </div> 



          <div class="form-group">
          <label for="">Zona</label>
          <select class="form-control" id="">
            <option>Lima</option>
            <option>Provincia</option>
          </select>
          </div>

          <div class="form-group mb50">
            <input type="submit" value="Calcular" class="btn btn-primary btn-block">
          </div>
        </form>
        </div>
        <div class="col-md-6">
            
            <div class="row" id="rowcanvas">
                <canvas id="canvas" width="2136" height="2068" class="chartjs-render-monitor"></canvas>
                
            </div>
            <div class="row" style="text-align: center">
                <div class="col-md-6">
                    <h3>Acumulado SBS</h3>
                    <h4 id="acummSBS"></h4>
                </div>
                <div class="col-md-6">
                    <h3>Acumulado Azure ML</h3>
                    <h4 id="acummAML"></h4>
                </div>
            </div>

        </div>
    </div>
</section>


<!-- chartjs logic -->
<script type="text/javascript" src="~/js/Chart.bundle.js"></script>
<script type="text/javascript" src="~/lib/jquery/dist/jquery.js"></script>
<script>


    // get form values

    //constantes
    const edadJubilacion = 65

    // from form
    let formValues = []
    let edad = 0
    let rentabilidadAnual = 0
    let sueldo = 0

    //calculated
    let rentabilidadMensual = 0
    let miFondo = 0
    let misFondos = []


    $(function() { //shorthand document.ready function
    $('#my-form').on('submit', function(e) { //use on if jQuery 1.7+
        e.preventDefault();  //prevent form from submitting
        var data = $("#my-form :input").serializeArray();
        formValues = data

        edad = Number(formValues[0].value)
        rentabilidadAnual = 10
        sueldo = Number(formValues[1].value)

        rantabilidadMayor = Number($('#mayorSesenta').val().replace('%',''))
        rentabilidadMenor= Number($('#menorSesenta').val().replace('%',''))

        rentabilidadMensual = (Math.pow(1 + rentabilidadAnual/100, 30 / 360) - 1)

        rentabilidadMayorMensual = (Math.pow(1 + rantabilidadMayor/100, 30 / 360) - 1)
        rentabilidadMenorMensual = (Math.pow(1 + rentabilidadMenor/100, 30 / 360) - 1)

        miFondo = calcularFondo(0,rentabilidadMensual,sueldo)
        misFondos = calcularFondos(edad, edadJubilacion,rentabilidadMenorMensual, rentabilidadMenorMensual, sueldo)

        //fondo AZURE ML
        misFondosRed = calcularFondos(edad, edadJubilacion, rentabilidadMenorMensual, rentabilidadMenorMensual, sueldo + 2000)
        
        //set accumulados
        document.getElementById("acummSBS").innerHTML = "S/." + formatMoney(misFondos.reduce((acc, fondo) => acc + fondo, 0).toFixed(2))
        document.getElementById("acummAML").innerHTML = "S/." + formatMoney(misFondosRed.reduce((acc, fondo) => acc + fondo, 0).toFixed(2))

        // load data to graph

        var barChartData = {
            labels: getYears(2018, 2018 + edadJubilacion - edad),
            datasets: [{
                label: 'SBS',
                backgroundColor: "rgba(138,197,242,1)",
                borderColor: "rgba(45,143,230,1)",
				borderWidth: 1,
                data: misFondos,
                fill: false,
            },{
                label: 'Azure ML',
                backgroundColor: "rgba(253,159,180,1)",
                borderColor: "rgba(252,72,113,1)",
				borderWidth: 1,
                data: misFondosRed,
                fill: false,
            }],
        }

        var ctx = document.getElementById('canvas').getContext('2d');
        window.myBar = new Chart(ctx, {
            type: 'line',
				data: barChartData,
				options: {
					responsive: true,
					legend: {
						position: 'top',
					},
					title: {
						display: true,
						text: 'Comisión por flujo'
					},
                    tooltips: {
					mode: 'index',
					intersect: false,
				},
				hover: {
					mode: 'nearest',
					intersect: true
				},
				scales: {
					xAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Mes'
						}
					}],
					yAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Monto'
						},
                        ticks: {
                        beginAtZero: true,
                        stepSize: 500000,
                        // Return an empty string to draw the tick line but hide the tick label
                        // Return `null` or `undefined` to hide the tick line entirely
                        userCallback: function(value, index, values) {
                            // Convert the number to a string and splite the string every 3 charaters from the end
                            value = value.toString();
                            value = value.split(/(?=(?:...)*$)/);
                            
                            // Convert the array to a string and format the output
                            value = value.join('.');
                            return 'S/.' + value;
                            }
                        }
					}]
				}
				}
        });

    });
    });

    function calcularFondos(edad, edadJubilacion, rentabilidadMenor, rentabilidadMayor, sueldo) {
        let anios = edadJubilacion - edad
        let misFondos = []

        // at the beginning starts at 0
        let fondoAux = 0
        let fondoCalculadoAux = 0

        let rentabilidad = rentabilidadMenor

        for (let iYear = 0; iYear < anios; iYear++) {

            if (iYear % 4 == 0 && edad < 60) {
                sueldo += 1500
            }

            // if (iYear == 7) {
            //     sueldo -= 7000
            // }

            if (edad >= 61) {
                rentabilidad = rentabilidadMayor
                sueldo -= 6500
            }
            
            auxSumMonth = 0

            for (let i = 0; i < 12; ++i) {
                fondoCalculadoAux = calcularFondo(fondoAux,rentabilidad,sueldo)
                auxSumMonth += fondoAux
                fondoAux = fondoCalculadoAux
            }
    
            misFondos.push(Number(auxSumMonth.toFixed(2)))
            auxSumMonth = 0
            edad += 1
        }

        
        return misFondos
    }

    function calcularFondo(fondo, rentabilidad, sueldo) {
        return fondo * (1 + rentabilidad) + 0.1 * sueldo
    }


    function getYears(fromYear, toYear) {
        
        if (fromYear == toYear) {
            return [fromYear + '']
        } else {

            let yearsToReturn = []
            const years = toYear - fromYear
            for (let i = 0; i <= years; i++) {
                yearsToReturn.push(fromYear + i + '')
            }
            return yearsToReturn
        }
        
    }

    function getMonths(fromYear, toYear) {
        let monthsTemplate = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"]
        let arrayMonths = []

        if (fromYear == toYear) {
            return concadenateYear(monthsTemplate, fromYear)
        } else {
            years = toYear - fromYear
            
            for (let i = 0; i <= years; i++) {
                console.log(Number(fromYear) + i);

                arrayMonths = arrayMonths.concat(concadenateYear(monthsTemplate, fromYear + i))
                monthsTemplate = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"]
            }
        }

        return arrayMonths
    }

    function concadenateYear(months, year) {
        console.log(year);
        for (let i = 0; i < months.length; i++) {
            months[i] = months[i] + " " + year
        }
        return months
    }

    function formatMoney(n, c, d, t) {
        var c = isNaN(c = Math.abs(c)) ? 2 : c,
            d = d == undefined ? "." : d,
            t = t == undefined ? "," : t,
            s = n < 0 ? "-" : "",
            i = String(parseInt(n = Math.abs(Number(n) || 0).toFixed(c))),
            j = (j = i.length) > 3 ? j % 3 : 0;

        return s + (j ? i.substr(0, j) + t : "") + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + t) + (c ? d + Math.abs(n - i).toFixed(c).slice(2) : "");
    }

</script>